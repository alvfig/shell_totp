#!/bin/sh
# tokens - shows time-based one-time passwords - TOTP
# Depends on oathtool package

rc=~/.tokensrc
[ -r $rc ] && . $rc
[ -z "$secretsfile" ] && secretsfile=tokens.secrets
[ -z "$barsytle" ] && barstyle=':.'

lasthalf=-1
while true; do
    seconds=`date '+%S'`
    half=`echo "$seconds / 30" | bc`
    remaining=`echo "30 - $seconds % 30" | bc`
    if [ $half -ne $lasthalf ]; then
        lasthalf=$half
        clear
        while read name secret; do
            token=`oathtool --totp --base32 $secret`
            printf '%-10.10s: %s\n' $name $token
        done < $secretsfile
        echo '\nType Ctrl-C to exit'
    fi
    bar=`printf '%-030.*d' $remaining 0 | tr '0 ' "$barstyle"`
    now=`date --iso-8601=seconds`
    printf '\rRemaining : %6d %s  %s' $remaining "$bar" $now
    sleep 1
done
