#!/bin/sh
# tokens - shows time-based one-time passwords - TOTP
# Depends on oathtool package

rc=~/.tokensrc
[ -r $rc ] && . $rc
[ -z "$secretsfile" ] && secretsfile=tokens.secrets
[ -z "$barsytle" ] && barstyle=':.'

while true; do
    clear
    seconds=`date '+%S'`
    elapsed=`expr $seconds % 30`
    remaining=`expr 30 - $elapsed`
    bar=`printf '%0*d%*s' $remaining 0 $elapsed '' | tr '0 ' "$barstyle"`
    now=`date --iso-8601=seconds`
    printf '%s\nRemaining : %6d %s\n\n' $now $remaining "$bar"
    while read name secret; do
        token=`oathtool --totp --base32 $secret`
        printf '%-10s: %s\n' $name $token
    done < $secretsfile
    echo; echo -n "Type Ctrl-C to exit"
    sleep 1
done
